<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Inflater.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/*
nochump.util.zip.Inflater
Copyright (C) 2007 David Chang (dchang@nochump.com)

This file is part of nochump.util.zip.

nochump.util.zip is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

nochump.util.zip is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with Foobar.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/</span>
<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">nochump</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">util</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">zip</span> <span class="ActionScriptBracket/Brace">{</span>
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Endian</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">ByteArray</span>;
    
    <span class="ActionScriptASDoc">/**
     * Inflater is used to decompress data that has been compressed according 
     * to the "deflate" standard described in rfc1950.
     *
     * The usage is as following.  First you have to set some input with
     * &lt;code&gt;setInput()&lt;/code&gt;, then inflate() it.
     * 
     * This implementation is a port of Puff by Mark Addler that comes with
     * the zlip data compression library.  It is not the fastest routine as
     * he intended it for learning purposes, his actual optimized inflater code
     * is very different.  I went with this approach basically because I got a
     * headache looking at the optimized inflater code and porting this
     * was a breeze.  The speed should be adequate but there is plenty of room
     * for improvements here.
     * 
     * @author dchang
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">Inflater</span> <span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">MAXBITS</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 15; <span class="ActionScriptComment">// maximum bits in a code
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">MAXLCODES</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 286; <span class="ActionScriptComment">// maximum number of literal/length codes
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">MAXDCODES</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 30; <span class="ActionScriptComment">// maximum number of distance codes
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">MAXCODES</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">MAXLCODES</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">MAXDCODES</span>; <span class="ActionScriptComment">// maximum codes lengths to read
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">FIXLCODES</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 288; <span class="ActionScriptComment">// number of fixed literal/length codes
</span>        <span class="ActionScriptComment">// Size base for length codes 257..285
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">LENS</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span>3<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 6<span class="ActionScriptOperator">,</span> 7<span class="ActionScriptOperator">,</span> 8<span class="ActionScriptOperator">,</span> 9<span class="ActionScriptOperator">,</span> 10<span class="ActionScriptOperator">,</span> 11<span class="ActionScriptOperator">,</span> 13<span class="ActionScriptOperator">,</span> 15<span class="ActionScriptOperator">,</span> 17<span class="ActionScriptOperator">,</span> 19<span class="ActionScriptOperator">,</span> 23<span class="ActionScriptOperator">,</span> 27<span class="ActionScriptOperator">,</span> 31<span class="ActionScriptOperator">,</span> 35<span class="ActionScriptOperator">,</span> 43<span class="ActionScriptOperator">,</span> 51<span class="ActionScriptOperator">,</span> 59<span class="ActionScriptOperator">,</span> 67<span class="ActionScriptOperator">,</span> 83<span class="ActionScriptOperator">,</span> 99<span class="ActionScriptOperator">,</span> 115<span class="ActionScriptOperator">,</span> 131<span class="ActionScriptOperator">,</span> 163<span class="ActionScriptOperator">,</span> 195<span class="ActionScriptOperator">,</span> 227<span class="ActionScriptOperator">,</span> 258<span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptComment">// Extra bits for length codes 257..285
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">LEXT</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptComment">// Offset base for distance codes 0..29
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">DISTS</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 7<span class="ActionScriptOperator">,</span> 9<span class="ActionScriptOperator">,</span> 13<span class="ActionScriptOperator">,</span> 17<span class="ActionScriptOperator">,</span> 25<span class="ActionScriptOperator">,</span> 33<span class="ActionScriptOperator">,</span> 49<span class="ActionScriptOperator">,</span> 65<span class="ActionScriptOperator">,</span> 97<span class="ActionScriptOperator">,</span> 129<span class="ActionScriptOperator">,</span> 193<span class="ActionScriptOperator">,</span> 257<span class="ActionScriptOperator">,</span> 385<span class="ActionScriptOperator">,</span> 513<span class="ActionScriptOperator">,</span> 769<span class="ActionScriptOperator">,</span> 1025<span class="ActionScriptOperator">,</span> 1537<span class="ActionScriptOperator">,</span> 2049<span class="ActionScriptOperator">,</span> 3073<span class="ActionScriptOperator">,</span> 4097<span class="ActionScriptOperator">,</span> 6145<span class="ActionScriptOperator">,</span> 8193<span class="ActionScriptOperator">,</span> 12289<span class="ActionScriptOperator">,</span> 16385<span class="ActionScriptOperator">,</span> 24577<span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptComment">// Extra bits for distance codes 0..29
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">DEXT</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 6<span class="ActionScriptOperator">,</span> 6<span class="ActionScriptOperator">,</span> 7<span class="ActionScriptOperator">,</span> 7<span class="ActionScriptOperator">,</span> 8<span class="ActionScriptOperator">,</span> 8<span class="ActionScriptOperator">,</span> 9<span class="ActionScriptOperator">,</span> 9<span class="ActionScriptOperator">,</span> 10<span class="ActionScriptOperator">,</span> 10<span class="ActionScriptOperator">,</span> 11<span class="ActionScriptOperator">,</span> 11<span class="ActionScriptOperator">,</span> 12<span class="ActionScriptOperator">,</span> 12<span class="ActionScriptOperator">,</span> 13<span class="ActionScriptOperator">,</span> 13<span class="ActionScriptBracket/Brace">]</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">inbuf</span>:<span class="ActionScriptDefault_Text">ByteArray</span>; <span class="ActionScriptComment">// input buffer
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">incnt</span>:<span class="ActionScriptDefault_Text">uint</span>; <span class="ActionScriptComment">// bytes read so far
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bitbuf</span>:<span class="ActionScriptDefault_Text">int</span>; <span class="ActionScriptComment">// bit buffer
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bitcnt</span>:<span class="ActionScriptDefault_Text">int</span>; <span class="ActionScriptComment">// number of bits in bit buffer
</span>        <span class="ActionScriptComment">// Huffman code decoding tables
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lencode</span>:<span class="ActionScriptDefault_Text">Object</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">distcode</span>:<span class="ActionScriptDefault_Text">Object</span>;
        
        <span class="ActionScriptASDoc">/**
         * Sets the input.
         * 
         * @param buf the input.
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setInput</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">inbuf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">buf</span>;
            <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Inflates the compressed stream to the output buffer.
         * 
         * @param buf the output buffer.
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">inflate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">incnt</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bitbuf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bitcnt</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">err</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// process blocks until last block or error
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">last</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// one if last block
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">type</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>2<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// block type 0..3
</span>                
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">stored</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// uncompressed block
</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> 3<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'invalid block type (type == 3)'</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// compressed block
</span>                    <span class="ActionScriptDefault_Text">lencode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">count</span>:[]<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">symbol</span>:[]<span class="ActionScriptBracket/Brace">}</span>;
                    <span class="ActionScriptDefault_Text">distcode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">count</span>:[]<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">symbol</span>:[]<span class="ActionScriptBracket/Brace">}</span>;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">constructFixedTables</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">constructDynamicTables</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">!=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">err</span>;
                    <span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">codes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// decode data until end-of-block code
</span>                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">!=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">break</span>; <span class="ActionScriptComment">// return with error
</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">last</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">err</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">need</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// bit accumulator (can use up to 20 bits)
</span>            <span class="ActionScriptComment">// load at least need bits into val
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">val</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bitbuf</span>;
            <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitcnt</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">need</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">incnt</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'available inflate data did not terminate'</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">val</span> <span class="ActionScriptOperator">|=</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&lt;&lt;</span> <span class="ActionScriptDefault_Text">bitcnt</span>; <span class="ActionScriptComment">// load eight bits
</span>                <span class="ActionScriptDefault_Text">bitcnt</span> <span class="ActionScriptOperator">+=</span> 8;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// drop need bits and update buffer, always zero to seven bits left
</span>            <span class="ActionScriptDefault_Text">bitbuf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">val</span> <span class="ActionScriptOperator">&gt;&gt;</span> <span class="ActionScriptDefault_Text">need</span>;
            <span class="ActionScriptDefault_Text">bitcnt</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">need</span>;
            <span class="ActionScriptComment">// return need bits, zeroing the bits above that
</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">val</span> <span class="ActionScriptOperator">&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span>1 <span class="ActionScriptOperator">&lt;&lt;</span> <span class="ActionScriptDefault_Text">need</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">h</span>:<span class="ActionScriptDefault_Text">Object</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">length</span>:<span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">n</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">offs</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> []; <span class="ActionScriptComment">// offsets in symbol table for each length
</span>            <span class="ActionScriptComment">// count number of codes of each length
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">MAXBITS</span>; <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptComment">// assumes lengths are within bounds
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">symbol</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">n</span>; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">++</span>;
            <span class="ActionScriptComment">// no codes! complete, but decode() will fail
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">n</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> 0;
            <span class="ActionScriptComment">// check for an over-subscribed or incomplete set of lengths
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">left</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptComment">// one possible code of zero length
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">MAXBITS</span>; <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">left</span> <span class="ActionScriptOperator">&lt;&lt;=</span> 1; <span class="ActionScriptComment">// one more bit, double codes left
</span>                <span class="ActionScriptDefault_Text">left</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">]</span>; <span class="ActionScriptComment">// deduct count from possible codes
</span>                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">left</span>; <span class="ActionScriptComment">// over-subscribed--return negative
</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptComment">// left &gt; 0 means incomplete
</span>            <span class="ActionScriptComment">// generate offsets into symbol table for each length for sorting
</span>            <span class="ActionScriptDefault_Text">offs</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">MAXBITS</span>; <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">offs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">offs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptComment">// put symbols in table sorted by length, by symbol order within each length
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">n</span>; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">!=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">offs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">symbol</span>;
            <span class="ActionScriptComment">// return zero for complete set, positive for incomplete set
</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">left</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">decode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">h</span>:<span class="ActionScriptDefault_Text">Object</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">code</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptComment">// len bits being decoded
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">first</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptComment">// first code of length len
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptComment">// index of first code of length len in symbol table
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">MAXBITS</span>; <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// current number of bits in code
</span>                <span class="ActionScriptDefault_Text">code</span> <span class="ActionScriptOperator">|=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// get next bit
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">count</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">]</span>; <span class="ActionScriptComment">// number of codes of length len
</span>                <span class="ActionScriptComment">// if length len, return symbol
</span>                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">code</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">h</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">code</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">first</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">count</span>; <span class="ActionScriptComment">// else update for next length
</span>                <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">count</span>;
                <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">&lt;&lt;=</span> 1;
                <span class="ActionScriptDefault_Text">code</span> <span class="ActionScriptOperator">&lt;&lt;=</span> 1;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptOperator">-</span>9; <span class="ActionScriptComment">// ran out of codes
</span>        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">codes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// decode literals and length/distance pairs
</span>            <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">symbol</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">decode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">symbol</span>; <span class="ActionScriptComment">// invalid symbol
</span>                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 256<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">symbol</span>; <span class="ActionScriptComment">// literal: symbol is the byte
</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&gt;</span> 256<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// length
</span>                    <span class="ActionScriptComment">// get and compute length
</span>                    <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">-=</span> 257;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&gt;=</span> 29<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"invalid literal/length or distance code in fixed or dynamic block"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>9<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">LENS</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">LEXT</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// length for copy
</span>                    <span class="ActionScriptComment">// get and check distance
</span>                    <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">decode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">distcode</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">symbol</span>; <span class="ActionScriptComment">// invalid symbol
</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dist</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">DISTS</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">DEXT</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// distance for copy
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"distance is too far back in fixed or dynamic block"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>10<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptComment">// copy length bytes from distance bytes back
</span>                    <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">dist</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">!=</span> 256<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// end of block symbol
</span>            <span class="ActionScriptReserved">return</span> 0; <span class="ActionScriptComment">// done with a valid fixed or dynamic block
</span>        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">stored</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buf</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// discard leftover bits from current byte (assumes s-&gt;bitcnt &lt; 8)
</span>            <span class="ActionScriptDefault_Text">bitbuf</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">bitcnt</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptComment">// get length and check against its one's complement
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">incnt</span> <span class="ActionScriptOperator">+</span> 4 <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'available inflate data did not terminate'</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span>; <span class="ActionScriptComment">// length of stored block
</span>            <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">|=</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&lt;&lt;</span> 8;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">~</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&amp;</span> 0xff<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">~</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&gt;&gt;</span> 8<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> 0xff<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"stored block length did not match one's complement"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>2<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">incnt</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'available inflate data did not terminate'</span><span class="ActionScriptOperator">,</span> 2<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">buf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">inbuf</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">incnt</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span>; <span class="ActionScriptComment">// copy len bytes from in to out
</span>        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">constructFixedTables</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lengths</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> [];
            <span class="ActionScriptComment">// literal/length table
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">symbol</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 144; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 8;
            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span>; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 256; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 9;
            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span>; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 280; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 7;
            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span>; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">FIXLCODES</span>; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 8;
            <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">FIXLCODES</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// distance table
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">MAXDCODES</span>; <span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 5;
            <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">distcode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">MAXDCODES</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">constructDynamicTables</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lengths</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> []; <span class="ActionScriptComment">// descriptor code lengths
</span>            <span class="ActionScriptComment">// permutation of code length codes
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">order</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span>16<span class="ActionScriptOperator">,</span> 17<span class="ActionScriptOperator">,</span> 18<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 8<span class="ActionScriptOperator">,</span> 7<span class="ActionScriptOperator">,</span> 9<span class="ActionScriptOperator">,</span> 6<span class="ActionScriptOperator">,</span> 10<span class="ActionScriptOperator">,</span> 5<span class="ActionScriptOperator">,</span> 11<span class="ActionScriptOperator">,</span> 4<span class="ActionScriptOperator">,</span> 12<span class="ActionScriptOperator">,</span> 3<span class="ActionScriptOperator">,</span> 13<span class="ActionScriptOperator">,</span> 2<span class="ActionScriptOperator">,</span> 14<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> 15<span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptComment">// get number of lengths in each table, check lengths
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nlen</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>5<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 257;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ndist</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>5<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 1;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ncode</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 4; <span class="ActionScriptComment">// number of lengths in descriptor
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nlen</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">MAXLCODES</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">ndist</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">MAXDCODES</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: too many length or distance codes"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>3<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// read code length code lengths (really), missing lengths are zero
</span>            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">ncode</span>; <span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">order</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>3<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span>; <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> 19; <span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">order</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptComment">// build huffman table for code lengths codes (use lencode temporarily)
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">err</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptOperator">,</span> 19<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">!=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: code lengths codes incomplete"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>4<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// read length/literal and distance code length tables
</span>            <span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">nlen</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">ndist</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">symbol</span>:<span class="ActionScriptDefault_Text">int</span>; <span class="ActionScriptComment">// decoded value
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span>:<span class="ActionScriptDefault_Text">int</span>; <span class="ActionScriptComment">// last length to repeat
</span>                <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">decode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&lt;</span> 16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">symbol</span>; <span class="ActionScriptComment">// length in 0..15
</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// repeat instruction
</span>                    <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptComment">// assume repeating zeros
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">==</span> 16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// repeat last length 3..6 times
</span>                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: repeat lengths with no first length"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>5<span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">]</span>; <span class="ActionScriptComment">// last length
</span>                        <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> 3 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>2<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">==</span> 17<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> 3 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>3<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// repeat zero 3..10 times
</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">=</span> 11 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptBracket/Brace">(</span>7<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// == 18, repeat zero 11..138 times
</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">symbol</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">nlen</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">ndist</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: repeat more than specified lengths"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>6<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">symbol</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptComment">// repeat last or zero symbol times
</span>                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// build huffman table for literal/length codes
</span>            <span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">nlen</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// only allow incomplete codes if just one code
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">&lt;</span> 0 <span class="ActionScriptOperator">||</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">&gt;</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">nlen</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">lencode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">!=</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: invalid literal/length code lengths"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>7<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// build huffman table for distance codes
</span>            <span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">construct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">distcode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">lengths</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">slice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nlen</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">ndist</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// only allow incomplete codes if just one code
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">&lt;</span> 0 <span class="ActionScriptOperator">||</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">err</span> <span class="ActionScriptOperator">&gt;</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">ndist</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">distcode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">count</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">!=</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"dynamic block code description: invalid distance code lengths"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptOperator">-</span>8<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">err</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
    <span class="ActionScriptBracket/Brace">}</span>
    
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
